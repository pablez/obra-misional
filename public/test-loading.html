<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test - Verificar Carga de Scripts</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      max-width: 1000px;
      margin: 0 auto;
      padding: 20px;
      background: #f8f9fa;
    }
    .status {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin: 10px 0;
      border-left: 4px solid #dc2626;
    }
    .status.ok {
      border-left-color: #22c55e;
    }
    .status.loading {
      border-left-color: #eab308;
    }
    h1 { margin-top: 0; }
    h2 { margin-top: 20px; }
    code {
      background: #f3f4f6;
      padding: 2px 6px;
      border-radius: 3px;
      font-family: 'Courier New', monospace;
    }
    .log-area {
      background: #1f2937;
      color: #e5e7eb;
      padding: 15px;
      border-radius: 8px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      max-height: 500px;
      overflow-y: auto;
      margin: 10px 0;
    }
    .log-line { margin: 3px 0; }
    .error { color: #f87171; }
    .success { color: #86efac; }
    .warning { color: #fbbf24; }
    .info { color: #93c5fd; }
  </style>
</head>
<body>
  <h1>üîç Test de Carga de Scripts</h1>
  <p>Este archivo verifica que todos los scripts cargan correctamente en el orden correcto.</p>

  <div id="status-container"></div>

  <h2>üìã Consola de Depuraci√≥n</h2>
  <div class="log-area" id="log-area"></div>

  <h2>‚öôÔ∏è Acciones</h2>
  <button onclick="testReload()">üîÑ Recargar Prueba</button>
  <button onclick="testLoadData()">üì• Probar Carga de Datos</button>
  <button onclick="testComponents()">üß© Probar Componentes</button>

  <script>
    const logArea = document.getElementById('log-area');
    const statusContainer = document.getElementById('status-container');

    // Override console.log para capturar logs
    const originalLog = console.log;
    const originalError = console.error;

    console.log = function(...args) {
      originalLog(...args);
      logLine(args.join(' '), 'info');
    };

    console.error = function(...args) {
      originalError(...args);
      logLine('ERROR: ' + args.join(' '), 'error');
    };

    function logLine(message, type = 'info') {
      const div = document.createElement('div');
      div.className = `log-line ${type}`;
      div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
      logArea.appendChild(div);
      logArea.scrollTop = logArea.scrollHeight;
    }

    function createStatusCard(name, status, details = '') {
      const card = document.createElement('div');
      card.className = `status ${status === 'loading' ? 'loading' : status === 'ok' ? 'ok' : ''}`;
      
      let icon = '‚ùå';
      if (status === 'ok') icon = '‚úÖ';
      if (status === 'loading') icon = '‚è≥';

      card.innerHTML = `
        <h3>${icon} ${name}</h3>
        <p>${details}</p>
      `;
      statusContainer.appendChild(card);
      return card;
    }

    // Test 1: Verificar que script.js defini√≥ variables globales
    function testScriptLoaded() {
      logLine('Verificando script.js...', 'info');
      
      const checks = [
        ['loadDataFromBackend', typeof loadDataFromBackend],
        ['reports', typeof reports],
        ['interviews', typeof interviews],
        ['notes', typeof notes],
        ['templates', typeof templates],
        ['missionaries', typeof missionaries],
        ['auditLog', typeof auditLog],
      ];

      let allOk = true;
      checks.forEach(([name, type]) => {
        const ok = type !== 'undefined';
        allOk = allOk && ok;
        const icon = ok ? '‚úì' : '‚úó';
        logLine(`${icon} ${name}: ${type}`, ok ? 'success' : 'error');
      });

      const card = createStatusCard(
        'script.js',
        allOk ? 'ok' : 'error',
        allOk ? 'Todas las variables globales definidas' : 'Algunas variables no est√°n definidas'
      );

      return allOk;
    }

    // Test 2: Verificar que los componentes est√°n definidos
    function testComponentsLoaded() {
      logLine('Verificando componentes...', 'info');

      const components = [
        ['LoaderComponent', typeof LoaderComponent],
        ['DashboardComponent', typeof DashboardComponent],
        ['AuditComponent', typeof AuditComponent],
        ['AlertsComponent', typeof AlertsComponent],
        ['TemplatesComponent', typeof TemplatesComponent],
        ['MissionariesComponent', typeof MissionariesComponent],
        ['AppCore', typeof AppCore],
      ];

      let allOk = true;
      components.forEach(([name, type]) => {
        const ok = type === 'object' || type === 'function';
        allOk = allOk && ok;
        const icon = ok ? '‚úì' : '‚úó';
        logLine(`${icon} ${name}: ${type}`, ok ? 'success' : 'error');
      });

      const card = createStatusCard(
        'Componentes',
        allOk ? 'ok' : 'error',
        allOk ? 'Todos los componentes cargados' : 'Algunos componentes no est√°n definidos'
      );

      return allOk;
    }

    // Test 3: Verificar AppCore estado
    function testAppCoreState() {
      logLine('Verificando AppCore.state...', 'info');

      if (typeof AppCore === 'undefined') {
        logLine('‚úó AppCore no est√° definido', 'error');
        return false;
      }

      const state = AppCore.getState();
      logLine(`üì¶ Estado actual:`, 'info');
      logLine(`  - isInitialized: ${state.isInitialized}`, 'info');
      logLine(`  - isLoading: ${state.isLoading}`, 'info');
      logLine(`  - dataReady: ${state.dataReady}`, 'info');

      const card = createStatusCard(
        'AppCore State',
        'ok',
        `isInitialized: ${state.isInitialized}, dataReady: ${state.dataReady}`
      );

      return true;
    }

    // Test 4: Intentar cargar datos
    async function testLoadData() {
      logLine('\n=== Iniciando prueba de carga de datos ===', 'warning');
      
      if (typeof loadDataFromBackend !== 'function') {
        logLine('‚úó loadDataFromBackend no existe', 'error');
        return;
      }

      try {
        logLine('üì• Llamando a loadDataFromBackend()...', 'info');
        await loadDataFromBackend();
        logLine('‚úì loadDataFromBackend() completada', 'success');
        
        logLine(`üìä Datos cargados:`, 'success');
        logLine(`  - reports: ${reports?.length || 0}`, 'info');
        logLine(`  - interviews: ${interviews?.length || 0}`, 'info');
        logLine(`  - notes: ${notes?.length || 0}`, 'info');
        logLine(`  - templates: ${templates?.length || 0}`, 'info');
        logLine(`  - missionaries: ${missionaries?.length || 0}`, 'info');
        logLine(`  - auditLog: ${auditLog?.length || 0}`, 'info');
      } catch (error) {
        logLine(`‚úó Error: ${error.message}`, 'error');
        logLine(`Stack: ${error.stack}`, 'error');
      }
    }

    // Test 5: Probar componentes
    function testComponents() {
      logLine('\n=== Probando componentes ===', 'warning');

      if (typeof DashboardComponent !== 'undefined' && DashboardComponent.init) {
        logLine('Inicializando DashboardComponent...', 'info');
        try {
          DashboardComponent.init();
          logLine('‚úì DashboardComponent inicializado', 'success');
        } catch (e) {
          logLine(`‚úó Error: ${e.message}`, 'error');
        }
      }
    }

    // Ejecutar tests cuando carga la p√°gina
    window.addEventListener('load', () => {
      logLine('=== P√°gina cargada ===', 'warning');
      
      setTimeout(() => {
        statusContainer.innerHTML = '';
        testScriptLoaded();
        testComponentsLoaded();
        testAppCoreState();
      }, 500);
    });

    function testReload() {
      statusContainer.innerHTML = '';
      logArea.innerHTML = '';
      testScriptLoaded();
      testComponentsLoaded();
      testAppCoreState();
    }
  </script>

  <!-- CARGAR SCRIPTS EN ORDEN -->
  <script src="script.js"></script>
  <script src="debug.js"></script>
  <script src="components/loader.js"></script>
  <script src="components/dashboard.js"></script>
  <script src="components/audit.js"></script>
  <script src="components/alerts.js"></script>
  <!-- templates.js removed -->
  <script src="components/missionaries.js"></script>
  <script src="components/core.js"></script>
</body>
</html>
